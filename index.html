<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document Generator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.3.2/html2canvas.min.js"></script>
</head>
<body>
    <h1>Dofinner</h1>
    *maks 5 doer og last ned eller risikerer du at mister informasjon*
    <form id="docForm">
        <div id="entries">
            <div class="entry">
                <label for="coordinates">koordinater fra google maps:</label>
                <input type="text" name="coordinates" required placeholder="lim inn"><br><br>

                <label for="description">Informasjon:</label>
                <textarea name="description" required placeholder="Navn, adresse, hvor mange doer, kvalitet"></textarea><br><br>

                <label for="image">Bilder:</label>
                <input type="file" name="image" accept="image/*" multiple required><br><br>
            </div>
        </div>
        <button type="button" onclick="addEntry()">LEGG TIL FLERE DOER</button><br><br>
        <button type="submit">last ned pdf</button>
    </form>

    <script>
        function addEntry() {
            const entry = document.createElement('div');
            entry.className = 'entry';
            entry.innerHTML = `
                <label for="coordinates">koordinater fra google maps:</label>
                <input type="text" name="coordinates" required placeholder="lim inn"><br><br>

                <label for="description">Informasjon:</label>
                <textarea name="description" required placeholder="Navn, adresse, hvor mange doer, kvalitet"></textarea><br><br>

                <label for="image">Bilder:</label>
                <input type="file" name="image" accept="image/*" multiple required><br><br>
            `;
            document.getElementById('entries').appendChild(entry);
        }

        document.getElementById('docForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const entries = document.getElementsByClassName('entry');

            let yOffset = 10; // Y offset for PDF content
            const maxYOffset = 270; // Maximum Y offset before adding a new page (adjust as needed)
            const pageWidth = doc.internal.pageSize.getWidth(); // Get page width
            const imageMargin = 10; // Margin between images
            const maxImageHeight = 60; // Maximum height for images
            const maxImageWidth = (pageWidth - 50) / 3; // Maximum width for each image to fit three images per line

            for (let entry of entries) {
                const coordinates = entry.querySelector('input[name="coordinates"]').value;
                const cleanedCoordinates = coordinates.replace(/[()]/g, ''); // Remove parentheses
                const [lat, lon] = cleanedCoordinates.split(',').map(coord => coord.trim());
                const swappedCoordinates = `[${lon}, ${lat}]`;

                const description = entry.querySelector('textarea[name="description"]').value;
                const imageFiles = entry.querySelector('input[name="image"]').files;

                if (yOffset + 20 > maxYOffset) {
                    doc.addPage();
                    yOffset = 10;
                }
                
                doc.text(`Coordinates: ${swappedCoordinates}`, 10, yOffset);
                yOffset += 10;
                
                doc.text(`Description: ${description}`, 10, yOffset);
                yOffset += 20;

                let xOffset = 10; // X offset for the first image
                let imagesInLine = 0; // Counter for images in the current line

                for (let i = 0; i < imageFiles.length; i++) {
                    const file = imageFiles[i];
                    const imgDataUrl = await readFileAsDataURL(file);
                    const img = await loadImage(imgDataUrl);

                    const aspectRatio = img.width / img.height;
                    let imgWidth, imgHeight;

                    if (aspectRatio > 1) {
                        // Landscape
                        imgWidth = Math.min(maxImageWidth, availableWidth / 3);
                        imgHeight = imgWidth / aspectRatio;
                    } else {
                        // Portrait
                        imgHeight = maxImageHeight;
                        imgWidth = imgHeight * aspectRatio;
                    }

                    if (xOffset + imgWidth > pageWidth - 10) {
                        xOffset = 10;
                        yOffset += imgHeight + imageMargin;
                        imagesInLine = 0;
                    }

                    if (yOffset + imgHeight > maxYOffset) {
                        doc.addPage();
                        yOffset = 10;
                        xOffset = 10;
                        imagesInLine = 0;
                    }

                    doc.addImage(imgDataUrl, 'JPEG', xOffset, yOffset, imgWidth, imgHeight);

                    xOffset += imgWidth + imageMargin;
                    imagesInLine++;

                    if (imagesInLine === 3) {
                        xOffset = 10;
                        yOffset += imgHeight + imageMargin;
                        imagesInLine = 0;
                    }
                }

                yOffset += maxImageHeight + 20; // Adjust yOffset to add space between entries
            }

            doc.save('document.pdf');
        });

        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function loadImage(url) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = url;
            });
        }
    </script>
</body>
</html>
